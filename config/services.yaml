parameters:
  mercure_secret: "%env(MERCURE_JWT_SECRET)%"
  media_upload_dir: '%kernel.project_dir%/public/uploads/media'
  media_public_prefix: '/uploads/media'
  stripe_secret_key: '%env(STRIPE_SECRET_KEY)%'
  stripe_webhook_secret: '%env(STRIPE_WEBHOOK_SECRET)%'
  app_public_base_url: '%env(APP_PUBLIC_BASE_URL)%'
  default_tax_percent: 20
  r2_account_id: '%env(string:R2_ACCOUNT_ID)%'
  r2_access_key: '%env(string:R2_ACCESS_KEY_ID)%'
  r2_secret_key: '%env(string:R2_SECRET_ACCESS_KEY)%'
  r2_bucket:     '%env(string:R2_BUCKET)%'
  r2_public_base_url: '%env(string:R2_PUBLIC_BASE_URL)%'

services:
  _defaults:
    autowire: true
    autoconfigure: true

  App\:
    resource: '../src/'
    exclude:
      - '../src/DependencyInjection/'
      - '../src/Entity/'
      - '../src/Kernel.php'

  App\Service\Mercure\JwtMercureService:
    arguments:
      $secret: '%mercure_secret%'

  App\Security\CustomAuthenticationSuccessHandler:
    arguments:
      $jwtMercureService: '@App\Service\Mercure\JwtMercureService'
      $jwtTokenManager: '@lexik_jwt_authentication.jwt_manager'

  App\Service\MediaUploader:
    arguments:
      $targetDir: '%media_upload_dir%'
      $publicPrefix: '%media_public_prefix%'

  Stripe\StripeClient:
    arguments:
      $config:
        api_key: '%stripe_secret_key%'

  App\Service\Stripe\StripeService:
    arguments:
        $em: '@doctrine.orm.entity_manager'
        $publicBaseUrl: '%env(APP_PUBLIC_BASE_URL)%'
        $defaultTaxPercent: '%env(int:DEFAULT_TAX_PERCENT)%'
        $stripeSecretKey: '%stripe_secret_key%'
        $stripeWebhookSecret: '%stripe_webhook_secret%'
    
  App\Service\StripePayoutService:
    arguments:
        $em: '@doctrine.orm.entity_manager'
        $stripeSecretKey: '%stripe_secret_key%'

  App\Controller\StripeWebhookController:
    arguments:
        $stripeSecretKey: '%stripe_secret_key%'
        $stripeWebhookSecret: '%stripe_webhook_secret%'

  # If you have an R2Storage service, inject the (possibly-empty) base url:
  App\Service\R2Storage:
    arguments:
      $accountId: '%r2_account_id%'
      $accessKey: '%r2_access_key%'
      $secretKey: '%r2_secret_key%'
      $bucket:    '%r2_bucket%'
      $publicBaseUrl: '%r2_public_base_url%'   # can be '' (empty)

  # RFC 7807 Error Handler
  App\EventListener\ApiExceptionListener:
    arguments:
      $environment: '%kernel.environment%'
    tags:
      - { name: kernel.event_listener, event: kernel.exception, priority: 10 }

  # ðŸ”’ Rate Limiting
  App\EventListener\RateLimitListener:
    arguments:
      $loginLimiter: '@limiter.login'
      $apiLimiter: '@limiter.api'
      $passwordResetLimiter: '@limiter.password_reset'
      $tokenRefreshLimiter: '@limiter.token_refresh'
      $registrationLimiter: '@limiter.registration'
    tags:
      - { name: kernel.event_subscriber }
